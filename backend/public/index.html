<!DOCTYPE html>
<html>
  <head>
    <title>Chatti</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="index.css">
  </head>
  <body>
      <div id="app">
    
        <div id="header">
            <div id="site-title"> Chatti </div>
        </div>

        <div id="chat-main">
            <!--LOGIN window-->
            <div id="loginWindow">
                <p>Enter your nickname</p>
                <p id="nickError"></p>
                <form id="setNickname">
                  <input size="35" id="nickname"> </input>
                  <button>Send</button>
                </form>
            </div>
            <!--CHAT window-->
            <div id="chat">
                <div id="messageWindow">
                            <ul id="messages"></ul>             
                </div>
                <div id="userWindow">
                    <div>Users:</div>
                    <ul id="users"></ul>
                </div>
            </div>

        </div>

        <div id="footer">
            <form id="form" action="">
                <input id="input" autocomplete="off" /><button>Send</button>
            </form>
        </div>
      </div>

      <script src="/socket.io/socket.io.js"></script>

      <script>
        
          const socket = io({autoConnect:false})
          console.log(socket)

          const sessionID = window.localStorage.getItem('sessionID')
          if(sessionID) {
            socket.auth = { sessionID }
            socket.connect()
          }


          const form = document.getElementById('form')
          const input = document.getElementById('input')
          const chat = document.getElementById('chat')
          const setNickname = document.getElementById('setNickname')
          const loginWindow = document.getElementById('loginWindow')
          const nickInput = document.getElementById('nickname')
          const messageWindow = document.getElementById('messageWindow')
          const userList = document.getElementById('users')

          const nickname = ''

          socket.on("session", ({ sessionID, userID }) => {
            // attach the session ID to the next reconnection attempts
            socket.auth = { sessionID }
            // store it in the localStorage
            window.localStorage.setItem('sessionID', sessionID)
            // save the ID of the user
            socket.userID = userID
            chat.style.display = 'grid'
            form.style.display = 'flex'
            loginWindow.style.display = 'none'
          })

          

          // SET NICKNAME EVENTHANDLER
          setNickname.addEventListener('submit', (e) => {
                e.preventDefault()

                if(nickInput.value){
                    socket.auth = { username:nickInput.value }
                    socket.connect()
                    chat.style.display = 'grid'
                    form.style.display = 'flex'
                    loginWindow.style.display = 'none'
                    document.title = `Chatti - ${nickInput.value}`
              }
          })

          socket.on('connected', (user, token) => {
                socket.emit('user_join', null)
          })

          //CHAT-MESSAGE EVENTHANDLER
          form.addEventListener('submit', (e) =>{
            e.preventDefault()

            if(input.value.startsWith('/w')){
                const words = input.value.split(' ')
                const toUser = words[1]
                const msgToUser = input.value.substr(input.value.indexOf(' ', input.value.indexOf(' ') + 1) + 1)

                console.log(toUser + ' -> ' +msgToUser)
                socket.emit('private_message', toUser, msgToUser)
                input.value = ''
            }

            else if(input.value) {
                socket.emit('chat message', input.value)
                input.value = ''
            }
          })




          const privateMessage = (element) => {
               console.log(element.username + ' ' + element.userID )
          }


          //USER JOIN
          socket.on('users', (users) => {
                const usersConnected = users.map(u => u)
                userList.innerHTML= ''
                usersConnected.forEach(element => {
                    const item = document.createElement('li')
                    item.innerHTML = element.username
                    item.addEventListener('click', () => {
                        privateMessage(element)
                    })
                    userList.appendChild(item)
                })
          })

          //CHAT MESSAGE
          socket.on('chat message', (msg) => {
            var item = document.createElement('li')
            item.innerHTML = msg
            messages.appendChild(item)
            messageWindow.scrollTo(0, messageWindow.scrollHeight)
          })

          //USER DISCONNECT
          socket.on('user_quit', (users) => {
            const usersConnected = users.map(u => u)
            userList.innerHTML=''
            usersConnected.forEach(element => {
                var item = document.createElement('li')
                item.innerHTML = element.username
                userList.appendChild(item)         
            })
          })

          socket.on("connect_error", (err) => {
            if (err.message === "invalid username") {
                console.log('Invalid username')
            }
            if (err.message === "invalid token") {
                console.log('invalid token')
            }

          })



      </script>
  </body>
</html>